name: Validate FSH Files



on:
  workflow_dispatch:
    inputs:
      run_sushi_validation:
        description: 'Run SUSHI validation (comprehensive build test)'
        required: false
        default: false
        type: boolean
      fail_on_sushi_errors:
        description: 'Fail workflow if SUSHI validation has errors'
        required: false
        default: false
        type: boolean
      generate_analysis_log:
        description: 'Generate comprehensive analysis log for AI review'
        required: false
        default: false
        type: boolean
#  pull_request:
#    paths:
#      - 'no-basis/input/fsh/**'
#      - 'no-basis/sushi-config.yaml'
#  push:
#    branches: [main]
#    paths:
#      - 'no-basis/input/fsh/**'
#      - 'no-basis/sushi-config.yaml'

# CONFIGURATION: The "short name" of the IG and the folder must be the same
# NB: Manually check the paths over
env:
  IG_SHORTNAME: no-basis
  # IG: ${{ vars.IG_KORTNAVN }}

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        
    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.x'
        
    - name: Cache Node.js modules
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          ${{ runner.os }}-

    - name: Install fsh-sushi
      run: npm install -g fsh-sushi

    - name: Install fsh-validator
      run: pip install -U git+https://github.com/glichtner/fsh-validator

    - name: Run fsh-validator
      run: |
        cd ${{ env.IG_SHORTNAME }}/input/fsh/
        echo "ðŸ” Running FSH validation..."
        # Run fsh-validator and capture exit code (don't fail immediately)
        fsh-validator --all --log-path fsh-validator.log || true
        echo "âœ… FSH validation completed"
        
    - name: Run SUSHI validation
      if: ${{ github.event.inputs.run_sushi_validation == 'true' }}
      continue-on-error: true
      timeout-minutes: 10
      run: |
        cd ${{ env.IG_SHORTNAME }}
        echo "ðŸ£ Running SUSHI build validation..."
        echo "Working directory: $(pwd)"
        echo "Contents before SUSHI:"
        ls -la
        # Try with --require-latest first, fallback without if it fails
        if timeout 300 sushi . --require-latest 2>&1 | tee sushi-validation.log; then
          echo "âœ… SUSHI validation completed successfully"
        else
          echo "âš ï¸  SUSHI with --require-latest failed, trying without flag..."
          timeout 300 sushi . 2>&1 | tee -a sushi-validation.log || true
        fi
        echo "Contents after SUSHI:"
        ls -la
        if [ -d "fsh-generated/resources" ]; then
          echo "âœ… Generated resources found:"
          ls -la fsh-generated/resources/ | head -20
          resource_count=$(ls -1 fsh-generated/resources/*.json 2>/dev/null | wc -l)
          echo "ðŸ“Š Total generated resources: $resource_count"
        else
          echo "âš ï¸  Warning: fsh-generated/resources directory not found"
        fi
        echo "âœ… SUSHI validation step completed (check logs for details)"
        
    - name: Display validation results
      if: always()
      run: |
        validation_failed=false
        
        # Display FSH validation results
        cd ${{ env.IG_SHORTNAME }}/input/fsh/
        if [ -f fsh-validator.log ]; then
          echo "ðŸ“Š FSH Validation Results:"
          echo "=========================="
          cat fsh-validator.log
          
          # Check if there are any errors (excluding "No instances defined" which is informational)
          if grep -v "No instances defined" fsh-validator.log | grep -q "ERROR\|FATAL"; then
            echo "âŒ FSH validation failed with errors"
            validation_failed=true
          elif grep -q "WARN" fsh-validator.log; then
            echo "âš ï¸  FSH validation completed with warnings"
          else
            echo "âœ… FSH validation passed successfully"
          fi
          
          # Count and report "No instances defined" messages separately as informational
          instance_warnings=$(grep -c "No instances defined" fsh-validator.log || echo "0")
          if [ "$instance_warnings" -gt 0 ]; then
            echo "â„¹ï¸  Note: $instance_warnings profile(s) have no example instances (informational only)"
          fi
        else
          echo "âš ï¸  No FSH validation log found"
        fi
        
        echo ""
        
        # Display SUSHI validation results if it was run
        if [ "${{ github.event.inputs.run_sushi_validation }}" == "true" ]; then
          cd ${{ github.workspace }}/${{ env.IG_SHORTNAME }}
          if [ -f sushi-validation.log ]; then
            echo "ðŸ£ SUSHI Validation Results:"
            echo "============================"
            cat sushi-validation.log
            
            # Check if SUSHI had errors
            if grep -q "error\|Error\|ERROR\|fatal\|Fatal\|FATAL" sushi-validation.log; then
              echo "âŒ SUSHI validation failed with errors"
              if [ "${{ github.event.inputs.fail_on_sushi_errors }}" == "true" ]; then
                echo "ðŸš« Workflow will fail due to SUSHI errors (fail_on_sushi_errors=true)"
                validation_failed=true
              else
                echo "âš ï¸  Continuing despite SUSHI errors (fail_on_sushi_errors=false)"
              fi
            elif grep -q "warn\|Warn\|WARN" sushi-validation.log; then
              echo "âš ï¸  SUSHI validation completed with warnings"
            else
              echo "âœ… SUSHI validation passed successfully"
            fi
          else
            echo "âš ï¸  SUSHI validation was enabled but no log found"
          fi
        else
          echo "â„¹ï¸  SUSHI validation was not enabled"
        fi
        
        # Exit with error if any validation failed
        if [ "$validation_failed" = true ]; then
          exit 1
        fi

    - name: Generate comprehensive analysis log
      if: ${{ always() && github.event.inputs.generate_analysis_log == 'true' }}
      run: |
        # Create debug/logs directory if it doesn't exist
        mkdir -p "${{ github.workspace }}/debug/logs"
        
        # Use timestamp for local log filename (more readable than run_id)
        TIMESTAMP=$(date -u '+%Y%m%d-%H%M%S')
        LOCAL_LOG="${{ github.workspace }}/debug/logs/validation-analysis-${TIMESTAMP}.md"
        ARTIFACT_LOG="${{ github.workspace }}/validation-analysis-${{ github.run_id }}.md"
        
        # Write to the local log (primary destination)
        ANALYSIS_LOG="$LOCAL_LOG"
        
        echo "# FSH Validation Analysis Report" > "$ANALYSIS_LOG"
        echo "" >> "$ANALYSIS_LOG"
        echo "**Run ID:** ${{ github.run_id }}" >> "$ANALYSIS_LOG"
        echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$ANALYSIS_LOG"
        echo "**Workflow:** validate-fsh.yml" >> "$ANALYSIS_LOG"
        echo "**Repository:** ${{ github.repository }}" >> "$ANALYSIS_LOG"
        echo "**Branch:** ${{ github.ref_name }}" >> "$ANALYSIS_LOG"
        echo "**Commit:** ${{ github.sha }}" >> "$ANALYSIS_LOG"
        echo "" >> "$ANALYSIS_LOG"
        
        # Configuration
        echo "## Configuration" >> "$ANALYSIS_LOG"
        echo "" >> "$ANALYSIS_LOG"
        echo "- **SUSHI Validation:** ${{ github.event.inputs.run_sushi_validation || 'false' }}" >> "$ANALYSIS_LOG"
        echo "- **Fail on SUSHI Errors:** ${{ github.event.inputs.fail_on_sushi_errors || 'false' }}" >> "$ANALYSIS_LOG"
        echo "- **Generate Analysis Log:** ${{ github.event.inputs.generate_analysis_log || 'true' }}" >> "$ANALYSIS_LOG"
        echo "- **IG Short Name:** ${{ env.IG_SHORTNAME }}" >> "$ANALYSIS_LOG"
        echo "" >> "$ANALYSIS_LOG"
        
        # FSH Validator Results
        echo "## FSH Validator Results" >> "$ANALYSIS_LOG"
        echo "" >> "$ANALYSIS_LOG"
        
        FSH_LOG_PATH="${{ github.workspace }}/${{ env.IG_SHORTNAME }}/input/fsh/fsh-validator.log"
        if [ -f "$FSH_LOG_PATH" ]; then
          # Statistics
          total_errors=$(grep -c "Failure:" "$FSH_LOG_PATH" 2>/dev/null || echo "0")
          instance_errors=$(grep -c "No instances defined" "$FSH_LOG_PATH" 2>/dev/null || echo "0")
          real_errors=$(grep -v "No instances defined" "$FSH_LOG_PATH" | grep -c "ERROR\|FATAL" 2>/dev/null || echo "0")
          warnings=$(grep -c "WARN" "$FSH_LOG_PATH" 2>/dev/null || echo "0")
          
          echo "### Summary Statistics" >> "$ANALYSIS_LOG"
          echo "" >> "$ANALYSIS_LOG"
          echo "| Metric | Count |" >> "$ANALYSIS_LOG"
          echo "|--------|------:|" >> "$ANALYSIS_LOG"
          echo "| Total Failure Messages | $total_errors |" >> "$ANALYSIS_LOG"
          echo "| Real Errors (ERROR/FATAL) | $real_errors |" >> "$ANALYSIS_LOG"
          echo "| Warnings | $warnings |" >> "$ANALYSIS_LOG"
          echo "| Missing Instance Messages | $instance_errors |" >> "$ANALYSIS_LOG"
          echo "" >> "$ANALYSIS_LOG"
          
          # Profiles without instances
          if [ "$instance_errors" -gt 0 ]; then
            echo "### Profiles Without Example Instances" >> "$ANALYSIS_LOG"
            echo "" >> "$ANALYSIS_LOG"
            echo "_These are informational only and do not indicate validation errors:_" >> "$ANALYSIS_LOG"
            echo "" >> "$ANALYSIS_LOG"
            grep "No instances defined for profile" "$FSH_LOG_PATH" | sed 's/.*for profile /- /' >> "$ANALYSIS_LOG"
            echo "" >> "$ANALYSIS_LOG"
          fi
          
          # Real errors if any
          if [ "$real_errors" -gt 0 ]; then
            echo "### âš ï¸ Real Validation Errors" >> "$ANALYSIS_LOG"
            echo "" >> "$ANALYSIS_LOG"
            echo "\`\`\`" >> "$ANALYSIS_LOG"
            grep -v "No instances defined" "$FSH_LOG_PATH" | grep -A2 "ERROR\|FATAL" >> "$ANALYSIS_LOG"
            echo "\`\`\`" >> "$ANALYSIS_LOG"
            echo "" >> "$ANALYSIS_LOG"
          fi
          
          # Full log in collapsible section
          echo "### Full FSH Validator Log" >> "$ANALYSIS_LOG"
          echo "" >> "$ANALYSIS_LOG"
          echo "<details>" >> "$ANALYSIS_LOG"
          echo "<summary>Click to expand full log</summary>" >> "$ANALYSIS_LOG"
          echo "" >> "$ANALYSIS_LOG"
          echo "\`\`\`" >> "$ANALYSIS_LOG"
          cat "$FSH_LOG_PATH" >> "$ANALYSIS_LOG"
          echo "\`\`\`" >> "$ANALYSIS_LOG"
          echo "" >> "$ANALYSIS_LOG"
          echo "</details>" >> "$ANALYSIS_LOG"
          echo "" >> "$ANALYSIS_LOG"
        else
          echo "âŒ **No FSH validator log found**" >> "$ANALYSIS_LOG"
          echo "" >> "$ANALYSIS_LOG"
        fi
        
        # SUSHI Results (if run)
        if [ "${{ github.event.inputs.run_sushi_validation }}" == "true" ]; then
          echo "## SUSHI Validation Results" >> "$ANALYSIS_LOG"
          echo "" >> "$ANALYSIS_LOG"
          
          SUSHI_LOG_PATH="${{ github.workspace }}/${{ env.IG_SHORTNAME }}/sushi-validation.log"
          if [ -f "$SUSHI_LOG_PATH" ]; then
            sushi_errors=$(grep -c "error\|Error\|ERROR\|fatal\|Fatal\|FATAL" "$SUSHI_LOG_PATH" 2>/dev/null || echo "0")
            sushi_warnings=$(grep -c "warn\|Warn\|WARN" "$SUSHI_LOG_PATH" 2>/dev/null || echo "0")
            
            echo "### Summary Statistics" >> "$ANALYSIS_LOG"
            echo "" >> "$ANALYSIS_LOG"
            echo "| Metric | Count |" >> "$ANALYSIS_LOG"
            echo "|--------|------:|" >> "$ANALYSIS_LOG"
            echo "| Errors | $sushi_errors |" >> "$ANALYSIS_LOG"
            echo "| Warnings | $sushi_warnings |" >> "$ANALYSIS_LOG"
            echo "" >> "$ANALYSIS_LOG"
            
            # Generated resources
            if [ -d "${{ github.workspace }}/${{ env.IG_SHORTNAME }}/fsh-generated/resources" ]; then
              resource_count=$(ls -1 "${{ github.workspace }}/${{ env.IG_SHORTNAME }}/fsh-generated/resources/"*.json 2>/dev/null | wc -l)
              echo "### Generated Resources" >> "$ANALYSIS_LOG"
              echo "" >> "$ANALYSIS_LOG"
              echo "**Total:** $resource_count JSON files" >> "$ANALYSIS_LOG"
              echo "" >> "$ANALYSIS_LOG"
            fi
            
            # Full log in collapsible section
            echo "### Full SUSHI Log" >> "$ANALYSIS_LOG"
            echo "" >> "$ANALYSIS_LOG"
            echo "<details>" >> "$ANALYSIS_LOG"
            echo "<summary>Click to expand full log</summary>" >> "$ANALYSIS_LOG"
            echo "" >> "$ANALYSIS_LOG"
            echo "\`\`\`" >> "$ANALYSIS_LOG"
            cat "$SUSHI_LOG_PATH" >> "$ANALYSIS_LOG"
            echo "\`\`\`" >> "$ANALYSIS_LOG"
            echo "" >> "$ANALYSIS_LOG"
            echo "</details>" >> "$ANALYSIS_LOG"
            echo "" >> "$ANALYSIS_LOG"
          else
            echo "âŒ **No SUSHI validation log found**" >> "$ANALYSIS_LOG"
            echo "" >> "$ANALYSIS_LOG"
          fi
        fi
        
        # Recommendations for Claude
        echo "## Analysis & Recommendations" >> "$ANALYSIS_LOG"
        echo "" >> "$ANALYSIS_LOG"
        echo "### For AI Review (Claude Sonnet)" >> "$ANALYSIS_LOG"
        echo "" >> "$ANALYSIS_LOG"
        echo "When reviewing this log, please analyze:" >> "$ANALYSIS_LOG"
        echo "" >> "$ANALYSIS_LOG"
        echo "1. **Validation Status:**" >> "$ANALYSIS_LOG"
        echo "   - Are there any real errors that need fixing?" >> "$ANALYSIS_LOG"
        echo "   - Are warnings acceptable or should they be addressed?" >> "$ANALYSIS_LOG"
        echo "   - Is the \"No instances defined\" count expected?" >> "$ANALYSIS_LOG"
        echo "" >> "$ANALYSIS_LOG"
        echo "2. **Pattern Analysis:**" >> "$ANALYSIS_LOG"
        echo "   - Are there recurring error patterns?" >> "$ANALYSIS_LOG"
        echo "   - Do multiple profiles have the same issues?" >> "$ANALYSIS_LOG"
        echo "   - Are there systemic problems vs isolated issues?" >> "$ANALYSIS_LOG"
        echo "" >> "$ANALYSIS_LOG"
        echo "3. **Recommendations:**" >> "$ANALYSIS_LOG"
        echo "   - What files need to be modified?" >> "$ANALYSIS_LOG"
        echo "   - Should workflow configuration be adjusted?" >> "$ANALYSIS_LOG"
        echo "   - Are there missing example instances that should be created?" >> "$ANALYSIS_LOG"
        echo "" >> "$ANALYSIS_LOG"
        
        # Workflow health
        echo "### Workflow Health Check" >> "$ANALYSIS_LOG"
        echo "" >> "$ANALYSIS_LOG"
        echo "- **Action Versions:** All updated to latest (v5/v6)" >> "$ANALYSIS_LOG"
        echo "- **Error Filtering:** Excludes 'No instances defined' from failures âœ…" >> "$ANALYSIS_LOG"
        echo "- **Exit Code Handling:** fsh-validator runs with \`|| true\` âœ…" >> "$ANALYSIS_LOG"
        echo "" >> "$ANALYSIS_LOG"
        
        echo "---" >> "$ANALYSIS_LOG"
        echo "" >> "$ANALYSIS_LOG"
        echo "_Generated automatically by validate-fsh.yml workflow_" >> "$ANALYSIS_LOG"
        
        # Copy to artifact location for GitHub upload
        cp "$LOCAL_LOG" "$ARTIFACT_LOG"
        
        # Display locations
        echo "ðŸ“Š Comprehensive analysis log generated:"
        echo "   Local: debug/logs/validation-analysis-${TIMESTAMP}.md"
        echo "   Artifact: validation-analysis-${{ github.run_id }}.md (will be uploaded)"
    
    - name: Commit and push analysis log
      if: ${{ always() && github.event.inputs.generate_analysis_log == 'true' }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add debug/logs/
        git diff --staged --quiet || git commit -m "Add validation analysis log from run ${{ github.run_id }}"
        git push
        
    - name: Upload validation artifacts
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: fsh-validation-results-${{ github.run_id }}
        path: |
          ${{ github.event.inputs.generate_analysis_log == 'true' && 'debug/logs/' || '' }}
          ${{ env.IG_SHORTNAME }}/input/fsh/fsh-validator.log
          ${{ env.IG_SHORTNAME }}/sushi-validation.log
          ${{ env.IG_SHORTNAME }}/fsh-generated/resources/*.json
          ${{ env.IG_SHORTNAME }}/input/fsh/**/*.fsh
          
    - name: Generate job summary
      if: always()
      run: |
        echo "## ðŸ” Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # FSH Validation Summary
        echo "### FSH Validator" >> $GITHUB_STEP_SUMMARY
        
        FSH_LOG_PATH="${{ github.workspace }}/${{ env.IG_SHORTNAME }}/input/fsh/fsh-validator.log"
        if [ -f "$FSH_LOG_PATH" ]; then
          # Exclude "No instances defined" from error count as it's informational
          fsh_error_count=$(grep -v "No instances defined" "$FSH_LOG_PATH" | grep -c "ERROR\|FATAL" || echo "0")
          fsh_warning_count=$(grep -c "WARN" "$FSH_LOG_PATH" || echo "0")
          instance_info_count=$(grep -c "No instances defined" "$FSH_LOG_PATH" || echo "0")
          
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| FSH Errors | $fsh_error_count |" >> $GITHUB_STEP_SUMMARY
          echo "| FSH Warnings | $fsh_warning_count |" >> $GITHUB_STEP_SUMMARY
          echo "| Profiles without instances (info) | $instance_info_count |" >> $GITHUB_STEP_SUMMARY
          
          if [ $fsh_error_count -gt 0 ]; then
            fsh_status="âŒ **Failed**"
          elif [ $fsh_warning_count -gt 0 ]; then
            fsh_status="âš ï¸ **Passed with Warnings**"
          else
            fsh_status="âœ… **Passed**"
          fi
        else
          fsh_status="âš ï¸ **No Log Generated**"
        fi
        
        # SUSHI Validation Summary (if enabled)
        if [ "${{ github.event.inputs.run_sushi_validation }}" == "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SUSHI Validation" >> $GITHUB_STEP_SUMMARY
          
          SUSHI_LOG_PATH="${{ github.workspace }}/${{ env.IG_SHORTNAME }}/sushi-validation.log"
          if [ -f "$SUSHI_LOG_PATH" ]; then
            sushi_error_count=$(grep -c "error\|Error\|ERROR\|fatal\|Fatal\|FATAL" "$SUSHI_LOG_PATH" || true)
            sushi_warning_count=$(grep -c "warn\|Warn\|WARN" "$SUSHI_LOG_PATH" || true)
            
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| SUSHI Errors | $sushi_error_count |" >> $GITHUB_STEP_SUMMARY
            echo "| SUSHI Warnings | $sushi_warning_count |" >> $GITHUB_STEP_SUMMARY
            
            if [ $sushi_error_count -gt 0 ]; then
              sushi_status="âŒ **Failed**"
            elif [ $sushi_warning_count -gt 0 ]; then
              sushi_status="âš ï¸ **Passed with Warnings**"
            else
              sushi_status="âœ… **Passed**"
            fi
          else
            sushi_status="âš ï¸ **No Log Generated**"
          fi
        else
          sushi_status="â­ï¸ **Skipped** (not enabled)"
        fi
        
        # Overall Summary
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Overall Status" >> $GITHUB_STEP_SUMMARY
        echo "- **FSH Validation:** $fsh_status" >> $GITHUB_STEP_SUMMARY
        echo "- **SUSHI Validation:** $sushi_status" >> $GITHUB_STEP_SUMMARY
        
        # Detailed Logs
        if [ -f "$FSH_LOG_PATH" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### FSH Validator Log" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat "$FSH_LOG_PATH" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ github.event.inputs.run_sushi_validation }}" == "true" ] && [ -f "$SUSHI_LOG_PATH" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SUSHI Validation Log" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat "$SUSHI_LOG_PATH" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi