name: SUSHI Build & Validate

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'no-basis/input/fsh/**'
      - 'no-basis/sushi-config.yaml'
      - 'no-basis/ig.ini'
  push:
    branches: [main]
    paths:
      - 'no-basis/input/fsh/**'
      - 'no-basis/sushi-config.yaml'
      - 'no-basis/ig.ini'

env:
  IG_SHORTNAME: no-basis

jobs:
  build-and-validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      
    - name: üñ•Ô∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: üíæ Cache FHIR packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.fhir/packages
          ~/.npm
        key: ${{ runner.os }}-fhir-${{ hashFiles('**/sushi-config.yaml') }}
        restore-keys: |
          ${{ runner.os }}-fhir-
          ${{ runner.os }}-

    - name: üì¶ Install SUSHI
      run: |
        echo "üì¶ Installing SUSHI (FSH compiler)..."
        npm install -g fsh-sushi
        echo "‚úÖ SUSHI version:"
        sushi --version
        
    - name: üîç Display environment info
      run: |
        echo "üîç Environment Information"
        echo "=========================="
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"
        echo "Working directory: $(pwd)"
        echo "IG directory: ${{ env.IG_SHORTNAME }}"
        echo ""
        echo "üìÇ Directory structure:"
        ls -la ${{ env.IG_SHORTNAME }}/
        echo ""
        echo "üìÇ FSH input structure:"
        ls -la ${{ env.IG_SHORTNAME }}/input/fsh/
        
    - name: üç£ Run SUSHI build
      id: sushi
      run: |
        set -x  # Enable verbose debugging
        cd ${{ env.IG_SHORTNAME }}
        echo "üç£ Running SUSHI to compile FSH files..."
        echo "Working directory: $(pwd)"
        echo "DEBUG: Directory contents before SUSHI:"
        ls -la
        echo ""
        echo "DEBUG: FSH input files:"
        find input/fsh -name "*.fsh" -type f | head -20
        echo ""
        
        # Run SUSHI and capture output
        echo "Running: sushi . --require-latest"
        if sushi . --require-latest 2>&1 | tee sushi-output.log; then
          echo ""
          echo "‚úÖ SUSHI build completed successfully (exit code: 0)"
          echo "build_status=success" >> $GITHUB_OUTPUT
        else
          exit_code=$?
          echo ""
          echo "‚ö†Ô∏è SUSHI build completed with errors (exit code: $exit_code)"
          echo "build_status=failed" >> $GITHUB_OUTPUT
        fi
        
        echo ""
        echo "DEBUG: Directory contents after SUSHI:"
        ls -la
        
        set +x  # Disable verbose debugging
        
    - name: üìä Analyze SUSHI output
      if: always()
      run: |
        cd ${{ env.IG_SHORTNAME }}
        
        echo "üìä SUSHI Build Results"
        echo "======================"
        echo ""
        
        if [ -f sushi-output.log ]; then
          # Count errors and warnings more accurately
          # Look for "X Errors" pattern from SUSHI summary
          if grep -q "Errors" sushi-output.log; then
            error_count=$(grep -oP '\d+(?= Errors)' sushi-output.log | tail -1 || echo "0")
            warning_count=$(grep -oP '\d+(?= Warnings?)' sushi-output.log | tail -1 || echo "0")
          else
            # Fallback to line counting if summary not found
            error_count=$(grep -ci "error" sushi-output.log || echo "0")
            warning_count=$(grep -ci "warn" sushi-output.log || echo "0")
          fi
          
          echo "üìà Statistics:"
          echo "  - Errors: $error_count"
          echo "  - Warnings: $warning_count"
          echo ""
          
          # Extract SUSHI results box if present
          if grep -q "SUSHI RESULTS" sushi-output.log; then
            echo "üì¶ SUSHI Results Summary:"
            sed -n '/SUSHI RESULTS/,/====/p' sushi-output.log
          fi
          
          # Save counts for later steps
          echo "error_count=$error_count" >> $GITHUB_ENV
          echo "warning_count=$warning_count" >> $GITHUB_ENV
        else
          echo "‚ö†Ô∏è No SUSHI output log found"
          echo "error_count=0" >> $GITHUB_ENV
          echo "warning_count=0" >> $GITHUB_ENV
        fi
        
    - name: üîé Verify generated resources
      if: always()
      continue-on-error: false
      run: |
        set -x  # Enable verbose debugging
        cd ${{ env.IG_SHORTNAME }}
        
        echo "üîé Verifying Generated Resources"
        echo "================================="
        echo ""
        echo "DEBUG: Current directory: $(pwd)"
        echo "DEBUG: Contents:"
        ls -la
        echo ""
        
        if [ -d "fsh-generated" ]; then
          echo "‚úÖ fsh-generated directory exists"
          echo "DEBUG: Contents of fsh-generated:"
          ls -la fsh-generated/
          echo ""
          
          if [ -d "fsh-generated/resources" ]; then
            echo "‚úÖ fsh-generated/resources directory exists"
            echo ""
            echo "üìÇ Generated resources directory contents (first 30):"
            ls -lh fsh-generated/resources/ | head -30
            echo ""
            
            # Count generated files by type
            echo "DEBUG: Counting resources by type..."
            profile_count=$(ls -1 fsh-generated/resources/StructureDefinition-*.json 2>/dev/null | wc -l | tr -d ' ')
            valueset_count=$(ls -1 fsh-generated/resources/ValueSet-*.json 2>/dev/null | wc -l | tr -d ' ')
            codesystem_count=$(ls -1 fsh-generated/resources/CodeSystem-*.json 2>/dev/null | wc -l | tr -d ' ')
            instance_count=$(ls -1 fsh-generated/resources/*.json 2>/dev/null | grep -v "StructureDefinition\|ValueSet\|CodeSystem\|ImplementationGuide" | wc -l | tr -d ' ')
            total_count=$(ls -1 fsh-generated/resources/*.json 2>/dev/null | wc -l | tr -d ' ')
            
            echo "üìä Resource counts:"
            echo "  - Total resources: $total_count"
            echo "  - Profiles/Extensions: $profile_count"
            echo "  - ValueSets: $valueset_count"
            echo "  - CodeSystems: $codesystem_count"
            echo "  - Instances: $instance_count"
            echo ""
            
            # Save for summary (ensure they're not empty)
            echo "total_resources=${total_count:-0}" >> $GITHUB_ENV
            echo "profile_count=${profile_count:-0}" >> $GITHUB_ENV
            echo "valueset_count=${valueset_count:-0}" >> $GITHUB_ENV
            echo "codesystem_count=${codesystem_count:-0}" >> $GITHUB_ENV
            echo "instance_count=${instance_count:-0}" >> $GITHUB_ENV
            
            if [ "$total_count" -eq 0 ]; then
              echo "‚ö†Ô∏è WARNING: No resources were generated!"
              echo "This might indicate a SUSHI build problem"
            fi
          else
            echo "‚ùå ERROR: fsh-generated/resources directory not found!"
            echo "DEBUG: What exists in fsh-generated:"
            find fsh-generated -type f 2>/dev/null || echo "Nothing found"
            echo ""
            echo "SUSHI may have failed to generate resources"
            exit 1
          fi
          
          if [ -d "fsh-generated/includes" ]; then
            echo "‚úÖ Generated includes directory exists"
            echo "DEBUG: Contents:"
            ls -lh fsh-generated/includes/
          else
            echo "‚ö†Ô∏è No includes directory generated"
          fi
        else
          echo "‚ùå ERROR: fsh-generated directory not found!"
          echo "DEBUG: Looking for any generated output..."
          find . -name "*generated*" -type d 2>/dev/null || echo "No generated directories found"
          echo ""
          echo "SUSHI may have failed completely"
          exit 1
        fi
        
        set +x  # Disable verbose debugging
        
    - name: üß™ Validate JSON structure
      if: always()
      continue-on-error: true
      id: json_validation
      run: |
        set -x  # Enable verbose debugging
        cd ${{ env.IG_SHORTNAME }}
        
        echo "üß™ Validating JSON Structure"
        echo "============================="
        echo ""
        echo "DEBUG: Current directory: $(pwd)"
        echo "DEBUG: Listing current directory:"
        ls -la
        echo ""
        
        validation_failed=false
        
        if [ -d "fsh-generated/resources" ]; then
          echo "‚úÖ fsh-generated/resources directory exists"
          echo "DEBUG: Contents of fsh-generated/resources:"
          ls -la fsh-generated/resources/
          echo ""
          
          # Count files
          file_count=$(ls -1 fsh-generated/resources/*.json 2>/dev/null | wc -l | tr -d ' ')
          echo "DEBUG: Number of JSON files found: $file_count"
          
          if [ "$file_count" -eq 0 ]; then
            echo "‚ö†Ô∏è No JSON files found in fsh-generated/resources/"
            echo "This is not an error - continuing..."
            exit 0
          fi
          
          invalid_count=0
          valid_count=0
          
          echo "Starting validation of $file_count JSON files..."
          echo ""
          
          for file in fsh-generated/resources/*.json; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "----------------------------------------"
              echo "Validating: $filename"
              
              # Try to validate with detailed error output
              if validation_output=$(python3 -m json.tool "$file" 2>&1 > /dev/null); then
                valid_count=$((valid_count + 1))
                echo "  ‚úÖ Valid JSON"
              else
                echo "  ‚ùå Invalid JSON"
                echo "  Error details:"
                echo "$validation_output" | head -10 | sed 's/^/    /'
                invalid_count=$((invalid_count + 1))
                validation_failed=true
              fi
            fi
          done
          
          echo ""
          echo "========================================="
          echo "JSON Validation Summary:"
          echo "  ‚úÖ Valid JSON files: $valid_count"
          echo "  ‚ùå Invalid JSON files: $invalid_count"
          echo "========================================="
          
          # Save result for later steps
          echo "json_validation_failed=$validation_failed" >> $GITHUB_OUTPUT
          
          if [ "$validation_failed" = true ]; then
            echo ""
            echo "‚ùå JSON validation FAILED - $invalid_count invalid file(s)"
            echo "validation_status=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo ""
            echo "‚úÖ All generated JSON files are valid"
            echo "validation_status=success" >> $GITHUB_OUTPUT
          fi
        else
          echo "‚ö†Ô∏è fsh-generated/resources directory not found"
          echo "DEBUG: Contents of fsh-generated (if exists):"
          ls -la fsh-generated/ 2>/dev/null || echo "fsh-generated directory does not exist"
          echo "‚ö†Ô∏è Skipping JSON validation"
          echo "validation_status=skipped" >> $GITHUB_OUTPUT
        fi
        
        set +x  # Disable verbose debugging
        
    - name: üìã Check for specific issues
      if: always()
      run: |
        cd ${{ env.IG_SHORTNAME }}
        
        echo "üìã Checking for Common Issues"
        echo "=============================="
        echo ""
        
        if [ -f sushi-output.log ]; then
          # Check for specific error patterns
          if grep -qi "could not be found" sushi-output.log; then
            echo "‚ö†Ô∏è Found 'could not be found' errors:"
            grep -i "could not be found" sushi-output.log || true
            echo ""
          fi
          
          if grep -qi "No instances defined" sushi-output.log; then
            echo "‚ÑπÔ∏è Profiles without instances (informational):"
            grep -i "No instances defined" sushi-output.log || true
            echo ""
          fi
          
          if grep -qi "duplicate" sushi-output.log; then
            echo "‚ö†Ô∏è Found duplicate definitions:"
            grep -i "duplicate" sushi-output.log || true
            echo ""
          fi
          
          if grep -qi "circular" sushi-output.log; then
            echo "‚ö†Ô∏è Found circular dependencies:"
            grep -i "circular" sushi-output.log || true
            echo ""
          fi
        fi
        
    - name: üì§ Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sushi-build-${{ github.run_id }}
        path: |
          ${{ env.IG_SHORTNAME }}/sushi-output.log
          ${{ env.IG_SHORTNAME }}/fsh-generated/resources/*.json
          ${{ env.IG_SHORTNAME }}/fsh-generated/includes/*
          ${{ env.IG_SHORTNAME }}/fsh-generated/fsh-index.txt
        retention-days: 30
        
    - name: üìä Generate job summary
      if: always()
      run: |
        echo "## üç£ SUSHI Build & Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Build status
        if [ "${{ steps.sushi.outputs.build_status }}" == "success" ]; then
          echo "### ‚úÖ Build Status: **SUCCESS**" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå Build Status: **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Statistics table
        echo "### üìä Build Statistics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Errors | ${error_count:-0} |" >> $GITHUB_STEP_SUMMARY
        echo "| Warnings | ${warning_count:-0} |" >> $GITHUB_STEP_SUMMARY
        echo "| Total Resources | ${total_resources:-0} |" >> $GITHUB_STEP_SUMMARY
        echo "| Profiles/Extensions | ${profile_count:-0} |" >> $GITHUB_STEP_SUMMARY
        echo "| ValueSets | ${valueset_count:-0} |" >> $GITHUB_STEP_SUMMARY
        echo "| CodeSystems | ${codesystem_count:-0} |" >> $GITHUB_STEP_SUMMARY
        echo "| Instances | ${instance_count:-0} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Full SUSHI output
        cd ${{ env.IG_SHORTNAME }}
        if [ -f sushi-output.log ]; then
          echo "### üìù SUSHI Output Log" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat sushi-output.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ‚ùå Fail if errors found
      if: always()
      run: |
        echo "üîç Final Error Check"
        echo "===================="
        echo ""
        echo "DEBUG: Build status from SUSHI step: '${{ steps.sushi.outputs.build_status }}'"
        echo "DEBUG: JSON validation status: '${{ steps.json_validation.outputs.validation_status }}'"
        echo "DEBUG: Error count from environment: '${error_count:-not set}'"
        echo ""
        
        has_errors=false
        
        # Check if SUSHI build failed
        if [ "${{ steps.sushi.outputs.build_status }}" != "success" ]; then
          echo "‚ùå Build failed - SUSHI returned non-zero exit code"
          echo "Check the 'Run SUSHI build' step above for details"
          has_errors=true
        fi
        
        # Check if JSON validation failed
        if [ "${{ steps.json_validation.outputs.validation_status }}" == "failed" ]; then
          echo "‚ùå JSON validation failed - invalid JSON files found"
          echo "Check the 'Validate JSON structure' step for details"
          has_errors=true
        fi
        
        # Check if errors were detected (convert to number for comparison)
        error_num=$(echo "${error_count:-0}" | grep -oE '[0-9]+' || echo "0")
        echo "DEBUG: Extracted error number: $error_num"
        
        if [ "$error_num" -gt 0 ]; then
          echo "‚ùå Build completed but $error_num error(s) were found"
          echo "Check the 'Analyze SUSHI output' step for details"
          has_errors=true
        fi
        
        if [ "$has_errors" = true ]; then
          echo ""
          echo "‚ùå ================================="
          echo "‚ùå Build FAILED - errors detected"
          echo "‚ùå Review the steps above"
          echo "‚ùå ================================="
          exit 1
        fi
        
        echo ""
        echo "‚úÖ ================================="
        echo "‚úÖ Build completed successfully!"
        echo "‚úÖ No errors found"
        echo "‚úÖ ================================="
