name: Generate Version Index Page

on:
  workflow_run:
    workflows: ["Publish FHIR IG Release"]
    types:
      - completed
  workflow_dispatch:

jobs:
  generate-index:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: üì• Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: üîç List available versions
        id: list_versions
        run: |
          # Get all version directories (semantic versioning format)
          VERSIONS=$(find . -maxdepth 1 -type d -name "[0-9]*.[0-9]*.[0-9]*" | sed 's|^\./||' | sort -V -r)

          # Check for current/development build
          CURRENT_EXISTS=""
          if [ -d "current" ] || [ -d "currentbuild" ]; then
            CURRENT_EXISTS="true"
          fi

          # Get other builds (manual builds, etc.) - exclude version dirs and known dirs
          OTHER_BUILDS=$(find . -maxdepth 1 -type d ! -name "." ! -name ".git" ! -name "current" ! -name "currentbuild" ! -name "[0-9]*.[0-9]*.[0-9]*" | sed 's|^\./||' | sort)

          echo "versions<<EOF" >> $GITHUB_OUTPUT
          echo "$VERSIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "current_exists=$CURRENT_EXISTS" >> $GITHUB_OUTPUT
          echo "other_builds<<EOF" >> $GITHUB_OUTPUT
          echo "$OTHER_BUILDS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "Found versions:"
          echo "$VERSIONS"
          echo "Found other builds:"
          echo "$OTHER_BUILDS"

      - name: üìù Generate index.html
        run: |
          cat > index.html << 'HTML_END'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>NoBasis FHIR Implementation Guide - Versions</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  body {
                      font-family: Verdana, 'DejaVu Sans', sans-serif;
                      line-height: 1.6;
                      color: #333;
                      background: #f5f5f5;
                      min-height: 100vh;
                      padding: 2rem;
                  }
                  .container {
                      max-width: 1000px;
                      margin: 0 auto;
                      background: white;
                      border: 1px solid #ddd;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                  }
                  .header {
                      background: #0d47a1;
                      color: white;
                      padding: 2rem 2rem 1.5rem;
                      border-bottom: 3px solid #1976d2;
                  }
                  .header h1 {
                      font-size: 2rem;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                  }
                  .header p {
                      font-size: 1rem;
                      opacity: 0.95;
                  }
                  .content {
                      padding: 2rem;
                  }
                  .section {
                      margin-bottom: 2rem;
                  }
                  .section h2 {
                      color: #0d47a1;
                      margin-bottom: 1rem;
                      font-size: 1.4rem;
                      border-bottom: 2px solid #0d47a1;
                      padding-bottom: 0.5rem;
                      font-weight: 600;
                  }
                  .version-grid {
                      display: grid;
                      gap: 0.75rem;
                      margin-top: 1rem;
                  }
                  .version-card {
                      background: #fff;
                      border: 1px solid #ccc;
                      border-left: 4px solid #0d47a1;
                      padding: 1rem 1.25rem;
                      transition: all 0.2s ease;
                      text-decoration: none;
                      color: inherit;
                      display: block;
                  }
                  .version-card:hover {
                      background: #f8f9fa;
                      border-left-color: #1976d2;
                      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                  }
                  .version-card.current {
                      background: #fff8e1;
                      border-left-color: #f57c00;
                  }
                  .version-card.current:hover {
                      background: #ffecb3;
                  }
                  .version-card.latest {
                      background: #e3f2fd;
                      border-left-color: #1976d2;
                      border-left-width: 5px;
                  }
                  .version-card.latest:hover {
                      background: #bbdefb;
                  }
                  .version-title {
                      font-size: 1.1rem;
                      font-weight: 600;
                      margin-bottom: 0.4rem;
                      color: #0d47a1;
                  }
                  .latest .version-title {
                      color: #01579b;
                  }
                  .version-badge {
                      display: inline-block;
                      padding: 0.2rem 0.6rem;
                      border-radius: 3px;
                      font-size: 0.7rem;
                      font-weight: 600;
                      text-transform: uppercase;
                      margin-left: 0.5rem;
                  }
                  .badge-latest {
                      background: #1976d2;
                      color: white;
                  }
                  .badge-stable {
                      background: #0d47a1;
                      color: white;
                  }
                  .badge-dev {
                      background: #f57c00;
                      color: white;
                  }
                  .version-description {
                      color: #555;
                      font-size: 0.9rem;
                      margin-top: 0.3rem;
                  }
                  .info-box {
                      background: #e8f4f8;
                      border-left: 4px solid #0d47a1;
                      padding: 1rem 1.25rem;
                      margin: 1.5rem 0;
                  }
                  .info-box p {
                      margin: 0.5rem 0;
                      color: #333;
                  }
                  .info-box strong {
                      color: #0d47a1;
                  }
                  .footer {
                      text-align: center;
                      padding: 1.5rem;
                      background: #f5f5f5;
                      color: #666;
                      font-size: 0.85rem;
                      border-top: 1px solid #ddd;
                  }
                  .footer a {
                      color: #0d47a1;
                      text-decoration: none;
                      font-weight: 600;
                  }
                  .footer a:hover {
                      text-decoration: underline;
                      color: #1976d2;
                  }
                  @media (max-width: 768px) {
                      body {
                          padding: 0.5rem;
                      }
                      .header h1 {
                          font-size: 1.5rem;
                      }
                      .header {
                          padding: 1.5rem 1rem 1rem;
                      }
                      .content {
                          padding: 1rem;
                      }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üè• NoBasis FHIR IG</h1>
                      <p>Norwegian Base Profiles for FHIR R4</p>
                  </div>
                  
                  <div class="content">
                      <div class="info-box">
                          <p><strong>About this Implementation Guide:</strong></p>
                          <p>EXPERIMENTAL - DO NOT USE FOR IMPLEMENTATION!</p>
                          <p>NoBasis defines the base FHIR profiles for healthcare IT systems in Norway. Choose a version below to view the complete implementation guide.</p>
                      </div>
          HTML_END

          # Add published versions section FIRST
          cat >> index.html << 'HTML_END'
                      <div class="section">
                          <h2>Published Versions</h2>
                          <div class="version-grid">
          HTML_END

          # Generate version cards
          FIRST=true
          while IFS= read -r version; do
            if [ -n "$version" ]; then
              if [ "$FIRST" = true ]; then
                cat >> index.html << HTML_END
                              <a href="${version}/" class="version-card latest">
                                  <div class="version-title">
                                      Version ${version}
                                      <span class="version-badge badge-latest">Latest</span>
                                  </div>
                                  <div class="version-description">
                                      Latest stable release. Recommended for production use.
                                  </div>
                              </a>
          HTML_END
                FIRST=false
              else
                cat >> index.html << HTML_END
                              <a href="${version}/" class="version-card">
                                  <div class="version-title">
                                      Version ${version}
                                      <span class="version-badge badge-stable">Stable</span>
                                  </div>
                                  <div class="version-description">
                                      Previous stable release.
                                  </div>
                              </a>
          HTML_END
              fi
            fi
          done <<< "${{ steps.list_versions.outputs.versions }}"

          # Close published versions section
          cat >> index.html << 'HTML_END'
                          </div>
                      </div>
          HTML_END

          # Add current/development build section if it exists
          if [ "${{ steps.list_versions.outputs.current_exists }}" == "true" ]; then
            cat >> index.html << 'HTML_END'
                      <div class="section">
                          <h2>Development Build</h2>
                          <div class="version-grid">
          HTML_END
            
            if [ -d "current" ]; then
              cat >> index.html << 'HTML_END'
                              <a href="current/" class="version-card current">
                                  <div class="version-title">
                                      Current Build
                                      <span class="version-badge badge-dev">Dev</span>
                                  </div>
                                  <div class="version-description">
                                      Latest development build from the main branch. May contain unreleased features and breaking changes.
                                  </div>
                              </a>
          HTML_END
            fi
            
            if [ -d "currentbuild" ]; then
              cat >> index.html << 'HTML_END'
                              <a href="currentbuild/" class="version-card current">
                                  <div class="version-title">
                                      Current Build
                                      <span class="version-badge badge-dev">Dev</span>
                                  </div>
                                  <div class="version-description">
                                      Latest development build from the main branch. May contain unreleased features and breaking changes.
                                  </div>
                              </a>
          HTML_END
            fi
            
            cat >> index.html << 'HTML_END'
                          </div>
                      </div>
          HTML_END
          fi

          # Add other builds section if any exist
          if [ -n "${{ steps.list_versions.outputs.other_builds }}" ]; then
            cat >> index.html << 'HTML_END'
                      <div class="section">
                          <h2>Other Builds</h2>
                          <div class="version-grid">
          HTML_END

            while IFS= read -r build; do
              if [ -n "$build" ]; then
                cat >> index.html << HTML_END
                              <a href="${build}/" class="version-card">
                                  <div class="version-title">
                                      ${build}
                                  </div>
                                  <div class="version-description">
                                      Special or manual build.
                                  </div>
                              </a>
          HTML_END
              fi
            done <<< "${{ steps.list_versions.outputs.other_builds }}"

            cat >> index.html << 'HTML_END'
                          </div>
                      </div>
          HTML_END
          fi

          # Close HTML
          cat >> index.html << 'HTML_END'
                      
                      <div class="info-box">
                          <p><strong>Need help?</strong></p>
                          <p>Visit the <a href="https://github.com/HL7Norway/basisprofiler-r4-fsh" target="_blank">GitHub repository</a> for documentation, issues, and discussions.</p>
                      </div>
                  </div>
                  
                  <div class="footer">
                      <p>Published by <a href="https://www.hl7.no" target="_blank">HL7 Norway</a></p>
                      <p>Implementation Guide built with <a href="https://github.com/HL7/fhir-ig-publisher" target="_blank">IG Publisher</a></p>
                  </div>
              </div>
          </body>
          </html>
          HTML_END

          echo "‚úÖ Generated index.html"

      - name: üöÄ Commit and push index page
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update version index page"
            git push
            echo "‚úÖ Pushed updated index.html"
          fi
