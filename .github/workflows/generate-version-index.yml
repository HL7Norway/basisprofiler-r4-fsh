name: Generate Version Index Page

on:
  workflow_run:
    workflows: ["Publish FHIR IG Release"]
    types:
      - completed
  workflow_dispatch:

jobs:
  generate-index:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: üì• Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: üîç List available versions
        id: list_versions
        run: |
          # Get all version directories (semantic versioning format)
          VERSIONS=$(find . -maxdepth 1 -type d -name "[0-9]*.[0-9]*.[0-9]*" | sed 's|^\./||' | sort -V -r)

          # Check for current/development build
          CURRENT_EXISTS=""
          if [ -d "current" ] || [ -d "currentbuild" ]; then
            CURRENT_EXISTS="true"
          fi

          # Get other builds (manual builds, etc.) - exclude version dirs and known dirs
          OTHER_BUILDS=$(find . -maxdepth 1 -type d ! -name "." ! -name ".git" ! -name "current" ! -name "currentbuild" ! -name "[0-9]*.[0-9]*.[0-9]*" | sed 's|^\./||' | sort)

          echo "versions<<EOF" >> $GITHUB_OUTPUT
          echo "$VERSIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "current_exists=$CURRENT_EXISTS" >> $GITHUB_OUTPUT
          echo "other_builds<<EOF" >> $GITHUB_OUTPUT
          echo "$OTHER_BUILDS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "Found versions:"
          echo "$VERSIONS"
          echo "Found other builds:"
          echo "$OTHER_BUILDS"

      - name: üìù Generate index.html
        run: |
          cat > index.html << 'HTML_END'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>NoBasis FHIR Implementation Guide - Versions</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  body {
                      font-family: Verdana, 'DejaVu Sans', sans-serif;
                      font-size: 13px;
                      line-height: 1.5;
                      color: #333333;
                      background-color: #ffffff;
                      margin: 0;
                      padding: 0;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      background: #ffffff;
                  }
                  .header {
                      background-color: #024a82;
                      color: #ffffff;
                      padding: 10px 20px;
                      border-bottom: 1px solid #003d6b;
                  }
                  .header h1 {
                      font-size: 24px;
                      font-weight: normal;
                      margin: 5px 0;
                      color: #ffffff;
                  }
                  .header p {
                      font-size: 13px;
                      margin: 3px 0 5px 0;
                      color: #d4e6f1;
                  }
                  .content {
                      padding: 20px;
                      background-color: #ffffff;
                  }
                  .section {
                      margin-bottom: 25px;
                  }
                  .section h2 {
                      color: #024a82;
                      font-size: 18px;
                      font-weight: bold;
                      margin-bottom: 10px;
                      padding-bottom: 5px;
                      border-bottom: 1px solid #cccccc;
                  }
                  .version-grid {
                      margin-top: 10px;
                  }
                  .version-card {
                      background-color: #f9f9f9;
                      border: 1px solid #cccccc;
                      margin-bottom: 8px;
                      padding: 10px 15px;
                      text-decoration: none;
                      color: #333333;
                      display: block;
                      transition: background-color 0.15s ease;
                  }
                  .version-card:hover {
                      background-color: #e8f4f8;
                      border-color: #024a82;
                  }
                  .version-card.current {
                      background-color: #fffacd;
                      border-color: #ffd700;
                  }
                  .version-card.current:hover {
                      background-color: #fff8b0;
                  }
                  .version-card.latest {
                      background-color: #e8f4f8;
                      border: 2px solid #024a82;
                      font-weight: bold;
                  }
                  .version-card.latest:hover {
                      background-color: #d4e6f1;
                  }
                  .version-title {
                      font-size: 14px;
                      font-weight: bold;
                      color: #024a82;
                      margin-bottom: 3px;
                  }
                  .latest .version-title {
                      color: #003d6b;
                  }
                  .version-badge {
                      display: inline-block;
                      padding: 2px 6px;
                      background-color: #024a82;
                      color: #ffffff;
                      font-size: 10px;
                      font-weight: bold;
                      text-transform: uppercase;
                      margin-left: 6px;
                      border-radius: 2px;
                  }
                  .badge-latest {
                      background-color: #003d6b;
                  }
                  .badge-stable {
                      background-color: #024a82;
                  }
                  .badge-dev {
                      background-color: #cc9900;
                  }
                  .version-description {
                      color: #666666;
                      font-size: 12px;
                      margin-top: 3px;
                      line-height: 1.4;
                  }
                  .info-box {
                      background-color: #e8f4f8;
                      border: 1px solid #b3d9e6;
                      border-left: 4px solid #024a82;
                      padding: 12px 15px;
                      margin: 15px 0;
                  }
                  .info-box p {
                      margin: 5px 0;
                      font-size: 13px;
                      color: #333333;
                      line-height: 1.5;
                  }
                  .info-box strong {
                      color: #024a82;
                      font-weight: bold;
                  }
                  .info-box a {
                      color: #024a82;
                      text-decoration: underline;
                  }
                  .info-box a:hover {
                      color: #003d6b;
                  }
                  .footer {
                      text-align: center;
                      padding: 15px 20px;
                      background-color: #f5f5f5;
                      color: #666666;
                      font-size: 11px;
                      border-top: 1px solid #cccccc;
                      margin-top: 20px;
                  }
                  .footer p {
                      margin: 3px 0;
                  }
                  .footer a {
                      color: #024a82;
                      text-decoration: none;
                  }
                  .footer a:hover {
                      text-decoration: underline;
                  }
                  table {
                      border-collapse: collapse;
                      width: 100%;
                  }
                  @media (max-width: 768px) {
                      body {
                          font-size: 12px;
                      }
                      .header {
                          padding: 8px 15px;
                      }
                      .header h1 {
                          font-size: 20px;
                      }
                      .content {
                          padding: 15px;
                      }
                      .section h2 {
                          font-size: 16px;
                      }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>no-basis</h1>
                      <p>Norwegian Base Profiles for FHIR R4</p>
                  </div>
                  
                  <div class="content">
                      <div class="info-box">
                          <p><strong>About this Implementation Guide</strong></p>
                          <p><strong>EXPERIMENTAL - DO NOT USE FOR IMPLEMENTATION</strong></p>
                          <p>NoBasis defines the base FHIR profiles for healthcare IT systems in Norway. Select a version below to view the complete implementation guide.</p>
                      </div>
          HTML_END

          # Add published versions section FIRST
          cat >> index.html << 'HTML_END'
                      <div class="section">
                          <h2>Published Versions</h2>
                          <div class="version-grid">
          HTML_END

          # Generate version cards
          FIRST=true
          while IFS= read -r version; do
            if [ -n "$version" ]; then
              if [ "$FIRST" = true ]; then
                cat >> index.html << HTML_END
                              <a href="${version}/" class="version-card latest">
                                  <div class="version-title">
                                      Version ${version}
                                      <span class="version-badge badge-latest">Latest</span>
                                  </div>
                                  <div class="version-description">
                                      Latest stable release. Recommended for production use.
                                  </div>
                              </a>
          HTML_END
                FIRST=false
              else
                cat >> index.html << HTML_END
                              <a href="${version}/" class="version-card">
                                  <div class="version-title">
                                      Version ${version}
                                      <span class="version-badge badge-stable">Stable</span>
                                  </div>
                                  <div class="version-description">
                                      Previous stable release.
                                  </div>
                              </a>
          HTML_END
              fi
            fi
          done <<< "${{ steps.list_versions.outputs.versions }}"

          # Close published versions section
          cat >> index.html << 'HTML_END'
                          </div>
                      </div>
          HTML_END

          # Add current/development build section if it exists
          if [ "${{ steps.list_versions.outputs.current_exists }}" == "true" ]; then
            cat >> index.html << 'HTML_END'
                      <div class="section">
                          <h2>Development Build</h2>
                          <div class="version-grid">
          HTML_END
            
            if [ -d "current" ]; then
              cat >> index.html << 'HTML_END'
                              <a href="current/" class="version-card current">
                                  <div class="version-title">
                                      Current Build
                                      <span class="version-badge badge-dev">Dev</span>
                                  </div>
                                  <div class="version-description">
                                      Latest development build from the main branch. May contain unreleased features and breaking changes.
                                  </div>
                              </a>
          HTML_END
            fi
            
            if [ -d "currentbuild" ]; then
              cat >> index.html << 'HTML_END'
                              <a href="currentbuild/" class="version-card current">
                                  <div class="version-title">
                                      Current Build
                                      <span class="version-badge badge-dev">Dev</span>
                                  </div>
                                  <div class="version-description">
                                      Latest development build from the main branch. May contain unreleased features and breaking changes.
                                  </div>
                              </a>
          HTML_END
            fi
            
            cat >> index.html << 'HTML_END'
                          </div>
                      </div>
          HTML_END
          fi

          # Add other builds section if any exist
          if [ -n "${{ steps.list_versions.outputs.other_builds }}" ]; then
            cat >> index.html << 'HTML_END'
                      <div class="section">
                          <h2>Other Builds</h2>
                          <div class="version-grid">
          HTML_END

            while IFS= read -r build; do
              if [ -n "$build" ]; then
                cat >> index.html << HTML_END
                              <a href="${build}/" class="version-card">
                                  <div class="version-title">
                                      ${build}
                                  </div>
                                  <div class="version-description">
                                      Special or manual build.
                                  </div>
                              </a>
          HTML_END
              fi
            done <<< "${{ steps.list_versions.outputs.other_builds }}"

            cat >> index.html << 'HTML_END'
                          </div>
                      </div>
          HTML_END
          fi

          # Close HTML
          cat >> index.html << 'HTML_END'
                      
                      <div class="info-box">
                          <p><strong>Documentation and Support</strong></p>
                          <p>For documentation, issues, and discussions, visit the <a href="https://github.com/HL7Norway/basisprofiler-r4-fsh" target="_blank">GitHub repository</a>.</p>
                      </div>
                  </div>
                  
                  <div class="footer">
                      <p>Published by <a href="https://www.hl7.no" target="_blank">HL7 Norway</a></p>
                      <p>Implementation Guide built with <a href="https://github.com/HL7/fhir-ig-publisher" target="_blank">FHIR IG Publisher</a></p>
                  </div>
              </div>
          </body>
          </html>
          HTML_END

          echo "‚úÖ Generated index.html"

      - name: üöÄ Commit and push index page
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update version index page"
            git push
            echo "‚úÖ Pushed updated index.html"
          fi
